<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Sistema de Planejamento Econômico</title>
    <link rel="stylesheet" href="/css/common-styles.css">
</head>
<body>
    <div class="container">
        <!-- O cabeçalho será inserido aqui pelo script -->
        
        <div class="auth-container">
            <div class="auth-tabs">
                <div class="auth-tab active" data-tab="login">Login</div>
                <div class="auth-tab" data-tab="register">Registrar</div>
            </div>
            
            <div id="login-content" class="auth-content active">
                <h2>Login</h2>
                <div id="loginErrorAlert" class="message error" style="display: none;"></div>
                <div id="loginSuccessAlert" class="message success" style="display: none;"></div>
                
                <form id="loginForm">
                    <div class="form-group">
                        <label for="username">Nome de usuário:</label>
                        <input type="text" id="username" name="username" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">Senha:</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    
                    <div class="remember-me">
                        <input type="checkbox" id="rememberMe" name="rememberMe">
                        <label for="rememberMe">Lembrar-me</label>
                    </div>
                    
                    <button type="submit" class="btn">Entrar</button>
                </form>
            </div>
            
            <div id="register-content" class="auth-content">
                <h2>Registrar</h2>
                <div id="registerErrorAlert" class="message error" style="display: none;"></div>
                <div id="registerSuccessAlert" class="message success" style="display: none;"></div>
                
                <form id="registerForm">
                    <div class="form-group">
                        <label for="registerUsername">Nome de usuário:</label>
                        <input type="text" id="registerUsername" name="username" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="registerPassword">Senha:</label>
                        <input type="password" id="registerPassword" name="password" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="registerName">Nome completo:</label>
                        <input type="text" id="registerName" name="name" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Pronomes:</label>
                        <div class="pronoun-selector">
                            <div class="pronoun-option">
                                <input type="radio" id="he_him" name="pronoun" value="HE_HIM" checked>
                                <label for="he_him">Ele/Dele</label>
                            </div>
                            <div class="pronoun-option">
                                <input type="radio" id="she_her" name="pronoun" value="SHE_HER">
                                <label for="she_her">Ela/Dela</label>
                            </div>
                            <div class="pronoun-option">
                                <input type="radio" id="they_them" name="pronoun" value="THEY_THEM">
                                <label for="they_them">Elu/Delu</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Tipo de Usuário:</label>
                        <div class="pronoun-selector">
                            <div class="pronoun-option">
                                <input type="radio" id="councillor" name="type" value="COUNCILLOR" checked>
                                <label for="councillor">Conselheiro</label>
                            </div>
                            <div class="pronoun-option">
                                <input type="radio" id="non_councillor" name="type" value="NON_COUNCILLOR">
                                <label for="non_councillor">Não-Conselheiro</label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="instanceSelectContainer" class="form-group">
                        <label for="instanceId">Instância associada:</label>
                        <select id="instanceId" name="instanceId" required>
                            <option value="">Carregando instâncias...</option>
                        </select>
                    </div>
                    
                    <div id="instanceInfoBox" class="info-tip" style="display: none;">
                        Uma nova instância WORKER será criada automaticamente para este usuário.
                    </div>
                    
                    <button type="submit" class="btn">Registrar</button>
                </form>
            </div>
        </div>
        
        <div id="welcomeSection" style="display:none;">
            <div class="user-welcome">
                <h2>Bem-vindo, <span id="userNameDisplay"></span>!</h2>
                <p>Você está logado como <strong id="userTypeDisplay"></strong></p>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="profile">Perfil</div>
                <div class="tab" data-tab="instance">Detalhes da Instância</div>
                <div class="tab" data-tab="related">Entidades Relacionadas</div>
            </div>
            
            <div id="profileTab" class="tab-content active">
                <h3>Informações do Usuário</h3>
                <div class="report-container">
                    <div class="report-item">
                        <div class="item-label">ID:</div>
                        <div id="userId"></div>
                    </div>
                    <div class="report-item">
                        <div class="item-label">Nome:</div>
                        <div id="userName"></div>
                    </div>
                    <div class="report-item">
                        <div class="item-label">Nome de Usuário:</div>
                        <div id="userUsername"></div>
                    </div>
                    <div class="report-item">
                        <div class="item-label">Tipo:</div>
                        <div id="userType"></div>
                    </div>
                    <div class="report-item">
                        <div class="item-label">Pronome:</div>
                        <div id="userPronoun"></div>
                    </div>
                </div>
            </div>
            
            <div id="instanceTab" class="tab-content">
                <h3>Detalhes da Instância</h3>
                <div id="instanceLoading" class="loading">Carregando detalhes da instância...</div>
                <div id="instanceContainer" class="report-container" style="display:none;"></div>
            </div>
            
            <div id="relatedTab" class="tab-content">
                <h3>Entidades Relacionadas</h3>
                <div id="relatedLoading" class="loading">Carregando entidades relacionadas...</div>
                <div id="relatedContainer" class="report-container" style="display:none;"></div>
            </div>
            
            <button id="logoutBtn" class="btn btn-secondary">Sair</button>
        </div>
    </div>

    <script src="/common-header.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Inserir o cabeçalho comum
            insertCommonHeader();
            
            // Gestão de abas de autenticação
            const authTabs = document.querySelectorAll('.auth-tab');
            const authContents = document.querySelectorAll('.auth-content');
            
            authTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Remover classe ativa de todas as abas e conteúdos
                    authTabs.forEach(t => t.classList.remove('active'));
                    authContents.forEach(c => c.classList.remove('active'));
                    
                    // Adicionar classe ativa à aba e conteúdo selecionados
                    this.classList.add('active');
                    document.getElementById(`${tabId}-content`).classList.add('active');
                });
            });
            
            // Configurar exibição condicional de campos baseado no tipo de usuário
            document.querySelectorAll('input[name="type"]').forEach(radio => {
                radio.addEventListener('change', updateUserTypeFields);
            });
            
            // Carregar instâncias para o formulário de registro
            loadInstancesForRegistration();
            
            // Inicializar campos para tipo de usuário
            updateUserTypeFields();
            
            // Código existente para login e registro aqui
            // ...
        });
        
        function updateUserTypeFields() {
            const userType = document.querySelector('input[name="type"]:checked').value;
            const instanceSelectContainer = document.getElementById('instanceSelectContainer');
            const instanceInfoBox = document.getElementById('instanceInfoBox');
            
            if (userType === 'COUNCILLOR') {
                instanceSelectContainer.style.display = 'block';
                instanceInfoBox.style.display = 'none';
            } else {
                instanceSelectContainer.style.display = 'none';
                instanceInfoBox.style.display = 'block';
            }
        }
        
        function loadInstancesForRegistration() {
            const instanceSelect = document.getElementById('instanceId');
            
            fetch('/api/instances')
                .then(response => response.ok ? response.json() : [])
                .then(instances => {
                    // Filtrar apenas COUNCIL e COMMITTEE
                    const filteredInstances = instances.filter(instance => 
                        instance.type === 'COUNCIL' || instance.type === 'COMMITTEE'
                    );
                    
                    // Limpar opções e adicionar padrão
                    instanceSelect.innerHTML = '<option value="">Selecione uma instância</option>';
                    
                    // Adicionar instâncias filtradas
                    filteredInstances.forEach(instance => {
                        const option = document.createElement('option');
                        option.value = instance.id;
                        option.textContent = `${instance.committeeName || instance.id} (${instance.type})`;
                        instanceSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar instâncias:', error);
                    instanceSelect.innerHTML = '<option value="">Erro ao carregar instâncias</option>';
                });
        }
        
        // Adicionar ou integrar o código existente de login, logout e registro
        // ...
    </script>
</body>
</html>